#variables:
#  DotNetCoverallsToken: define this in Azure
#  NoCoverageUpload: (optional) define this in Azure. Default = false.
steps:
- powershell: |
   Remove-Item CodeCoverage -Force -Recurse -ErrorAction Ignore
   New-Item CodeCoverage -ItemType Directory -Force
  displayName: 'Create Code Coverage directory'

# - task: petergroenewegen.PeterGroenewegen-Xpirit-Vsts-Build-InlinePowershell.Xpirit-Vsts-Build-InlinePowershell.InlinePowershell@1
#   displayName: 'Start CosmosDB Emulator'
#   inputs:
#     Script: |
#         Write-Host "Starting CosmosDB Emulator on Windows"
#         Import-Module "C:/Program Files/Azure Cosmos DB Emulator/PSModules/Microsoft.Azure.CosmosDB.Emulator"
#         Start-CosmosDbEmulator

- task: Npm@1
  displayName: 'install botframework-cli to set up for Schema merge tests.'
  inputs:
    command: custom
    verbose: false
    customCommand: 'install -g @microsoft/botframework-cli@next'

- task: DotNetCoreCLI@2
  displayName: 'dotnet test (release) 2.1'
  inputs:
    command: test
    projects: |
     Tests/**/*Tests.csproj
     !Tests/**/Microsoft.Bot.Builder.TestBot.Tests.csproj
     !Tests/**/Microsoft.Bot.Builder.AI.Orchestrator.Tests.csproj
     
    arguments: '-v n  -f netcoreapp2.1 --configuration release --no-build --no-restore --filter "TestCategory!=IgnoreInAutomatedBuild&TestCategory!=FunctionalTests" --collect:"Code Coverage" --settings $(Build.SourcesDirectory)\CodeCoverage.runsettings'
  condition: and(eq(variables['BuildConfiguration'],'Release-Windows'), eq(variables['BuildTarget'],'netcoreapp21'))

- task: DotNetCoreCLI@2
  displayName: 'dotnet test (release) 3.1'
  inputs:
    command: test
    projects: |
     Tests/**/*Tests.csproj
     !Tests/**/*21.Tests.csproj

    arguments: '-v n  -f netcoreapp3.1 --configuration release --no-build --no-restore --filter "TestCategory!=IgnoreInAutomatedBuild&TestCategory!=FunctionalTests" --collect:"Code Coverage" --settings $(Build.SourcesDirectory)\CodeCoverage.runsettings'
  condition: and(eq(variables['BuildConfiguration'],'Release-Windows'), eq(variables['BuildTarget'],'netcoreapp31'))

- powershell: |
   # This task copies the code coverage file created by dotnet test into a well known location. In all
   # checks I've done, dotnet test ALWAYS outputs the coverage file to the temp directory. 
   # My attempts to override this and have it go directly to the CodeCoverage directory have
   # all failed, so I'm just doing the copy here.  (cmullins)
   
   Get-ChildItem -Path "D:\a\_temp" -Include "*.coverage" -Recurse | Copy-Item -Destination CodeCoverage
  displayName: 'Copy .coverage Files to CodeCoverage folder'
  condition: eq(variables['BuildConfiguration'],'Release-Windows')

- powershell: 'echo ''##vso[task.setvariable variable=CoverallsToken]$(DotNetCoverallsToken)'''
  displayName: 'Set CoverallsToken for PublishToCoveralls.ps1 if token exists'
  continueOnError: true
  condition: and(succeeded(), ne(variables['NoCoverageUpload'], 'true'), eq(variables['BuildConfiguration'],'Release-Windows'))

- task: PowerShell@2
  displayName: 'Upload Coverage Files to Coveralls.io https://coveralls.io/github/microsoft/botbuilder-dotnet'
  inputs:
    targetType: filePath
    filePath: '$(Build.SourcesDirectory)\build\PublishToCoveralls.ps1'
    arguments: '-pathToCoverageFiles "$(Build.SourcesDirectory)\CodeCoverage" -serviceName "master CI-PR"'
  continueOnError: true
  condition: and(succeeded(), ne(variables['CoverallsToken'], ''), ne(variables['NoCoverageUpload'], 'true'), eq(variables['BuildConfiguration'],'Release-Windows'))

- task: PublishBuildArtifacts@1
  displayName: 'Publish build artifact CodeCoverage'
  inputs:
    PathtoPublish: CodeCoverage
    ArtifactName: CodeCoverage
  enabled: false

- powershell: |
   git clone https://joel.mut:nmwe4rrsitb36s6h36nq3ted3u6nzvwd4qtalufkjpyypmvllfua@dev.azure.com/joelmut93/manx-pipeline-testing/_git/manx-pipeline-testing $(System.DefaultWorkingDirectory)\..\outputLibraries
   $buildTarget = $env:BuildConfiguration.Split("-")[0];
   $env:BotBuilderDll.Split(",") | ForEach {
       $library = $_.Trim()
       Write-Host $library
       Get-ChildItem -Path "*/$library/bin/$buildTarget/netstandard2.0/$library.dll" -Recurse | Copy-Item -Destination '$(System.DefaultWorkingDirectory)\..\outputLibraries\' -Force
       Get-ChildItem -Path "*/*/$library/bin/$buildTarget/netstandard2.0/$library.dll" -Recurse | Copy-Item -Destination '$(System.DefaultWorkingDirectory)\..\outputLibraries\' -Force
   }
  displayName: 'Prepare DLLs'

- script: |
    git config --global user.name "GitPythonDeploymentUser"
    git config --global user.email GitPythonDeploymentUser@Pipeline.com

    cd $(System.DefaultWorkingDirectory)\..\outputLibraries
    git add .
    git commit -m 'test'
    git push
  displayName: 'Upload DLLs'

- script: |
   cd ..
   dir *.* /s
  displayName: 'Dir workspace'
  continueOnError: true
  condition: succeededOrFailed()
